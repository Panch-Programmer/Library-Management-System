<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Search</title>
    <link rel="stylesheet" href="../student_search/student_Search.css">
</head>

<body>
    <header>
        <h1>Find Books</h1>
        <div id="studentIdDisplay"></div>

    </header>

    <section class="catalouge">
        <h2>Loaned Books</h2>
        <table class="books">
            <thead>
                <tr>
                    <th>Book Name</th>
                    <th>Date Issued</th>
                    <th>Due In</th>
                </tr>
            </thead>
            <tbody id="tableB">
            </tbody>
        </table>
    </section>

    <footer>
        <a href="../studentHome/studentHome.html" id="scrolldown">&lt Back To Previous Page</a>
    </footer>
</body>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs, addDoc, query, where, updateDoc, deleteDoc, arrayUnion, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCkguRAkkhEfu4JIjFgh7lrDbcv5jQ21ps",
        authDomain: "lms1-2fdcb.firebaseapp.com",
        projectId: "lms1-2fdcb",
        storageBucket: "lms1-2fdcb.appspot.com",
        messagingSenderId: "952940918932",
        appId: "1:952940918932:web:9f757d9f2d77e445049c81"
    };
    const app = initializeApp(firebaseConfig);

    const fire_db = getFirestore(app);

    const auth = getAuth(app);
    const user = auth.currentUser;

    let user_id = auth.currentUser;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById("studentIdDisplay").textContent = user.email;
            user_id = user.uid;
            displayBooks()
            // ...
        } else {
            // User is signed out
            console.log('no log in')
            // ...
        }
    });

    const tableB = document.getElementById('tableB');

    async function displayBooks() {
        const patron = doc(fire_db, 'student', user_id)
        const patron_info = await getDoc(patron)
        var row = "";
        if (patron_info.exists()) {
            const books = patron_info.data().books_issued
            for (const key in books) {
                const timestampString = books[key].timestamp;
                const issueDate = new Date(timestampString)
                const issueDateString = ((issueDate).toISOString().split('T')[0]);
                const todayDate = (new Date())
                const daysDifference = Math.floor((todayDate - issueDate) / (1000 * 60 * 60 * 24));
                row += `<tr>
                        <td>${books[key].bookName}</td>
                        <td>${issueDateString}</td>
                        <td style="color: red;">${14 - daysDifference} days</td>
                        </tr>`
            }
            tableB.innerHTML = row
        }
        else {
            console.log('No books issued')
        }
    }
</script>

</html>