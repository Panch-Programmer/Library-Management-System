<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="../add_remove/add_remove.css">
    <link rel="stylesheet" href="./defaulter_list.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defaulter List</title>
</head>

<body>
    <header>
        <h1>Defaulters</h1>
    </header>
    <main>
        <section class="catalouge">
            <table class="books">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Book Name</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id='tableB'>
                </tbody>
            </table>
        </section>
    </main>
    <aside>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" id="info"></button>
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog"
            aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">More Info</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <table id="moreInfoBody"></table>
                    </div>
                </div>
            </div>
        </div>
    </aside>
    <footer>
        <a href="../adminHome/adminHome.html" id="scroll-down">&lt Back To Previous Page</a>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, addDoc, query, where, updateDoc, deleteDoc, arrayUnion, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCkguRAkkhEfu4JIjFgh7lrDbcv5jQ21ps",
            authDomain: "lms1-2fdcb.firebaseapp.com",
            projectId: "lms1-2fdcb",
            storageBucket: "lms1-2fdcb.appspot.com",
            messagingSenderId: "952940918932",
            appId: "1:952940918932:web:9f757d9f2d77e445049c81"
        };
        const app = initializeApp(firebaseConfig);

        const fire_db = getFirestore(app);
        const studentref = collection(fire_db, 'student')
        const loanRef = collection(fire_db, 'loan');

        const tableB = document.getElementById('tableB');

        async function displayBooks() {
            const issue_info = await getDocs(loanRef)
            var row = ""
            issue_info.forEach((doc) => {
                const loans = doc.data()
                let timestampString = loans.timestamp;
                timestampString = timestampString.replace(/^"|"$/g, '');
                const issueDate = new Date(timestampString)
                const issueDateString = ((issueDate).toISOString().split('T')[0]);
                const todayDate = (new Date())
                const defaulter = Math.floor((todayDate - issueDate) / (1000 * 60 * 60 * 24));
                if (defaulter > 14) {
                    const row = document.createElement('tr')
                    row.className = 'fine'

                    const studentColumn = document.createElement('td')
                    studentColumn.textContent = loans.studentEmail
                    row.appendChild(studentColumn)

                    const bookColumn = document.createElement('td')
                    bookColumn.textContent = loans.bookName
                    row.appendChild(bookColumn)

                    const moreInfo = document.createElement('td')
                    const moreInfoBtn = document.createElement('button')
                    moreInfoBtn.className = 'moreInfo'
                    moreInfoBtn.textContent = 'More Info'
                    moreInfo.appendChild(moreInfoBtn)
                    row.appendChild(moreInfo)
                    moreInfoBtn.addEventListener('click', () => {
                        getInfo(loans.studentEmail, loans.bookName, issueDateString, defaulter)
                    })
                    tableB.appendChild(row)

                }
            })

        }

        function getInfo(id, book, issueDate, days) {
            const btn = document.getElementById('info')
            btn.click()
            const infoBody = document.getElementById('moreInfoBody')
            infoBody.innerHTML = `<tr>
                                    <th>Student ID</th>
                                    <th>${id}</th>
                                </tr>
                                <tr>
                                    <td>Book Name</td>
                                    <td>${book}</td>
                                </tr>
                                <tr>
                                    <td>Issue Date</td>
                                    <td>${issueDate}</td>
                                </tr>
                                <tr>
                                    <td>Days Overdue</td>
                                    <td style = "color: red;">${days - 14}</td>
                                </tr>
                                <tr>
                                    <td>Fines</td>
                                    <td style = "color: red;">$${parseFloat(1.5 * (days - 14))}</td>
                                </tr>`

        }
        displayBooks();

    </script>
</body>

</html>
